<!doctype html>
<html>
<head>
	<script src='SVGPathInfo.js' ></script>
	<script src='commensurate.js' ></script>
	<style>
	body{
		overflow:hidden;
	}
	svg{

	}
	#pp, #ss, #rr
	{
		font-size:12px;
		position:absolute;
		top:185px;
		cursor:pointer;
	}
	#pp{
		left:31px;
	}
	#rr{
		left:57px;
	}
	</style>
</head>

<body>


<svg id='svg' version="1.1" id="svg1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="500" height="500" viewBox="0 -700 1000 1000" xml:space="preserve" >

  <path class="path" id='path' fill="none" stroke="#000000" stroke-width="0.3" transform="translate(140,75), scale(1,-1)" stroke-miterlimit="10" stroke-linejoin="round" d="M0 100" />
</svg>
<div id='ss'>start/</div>
<div id='pp'>/stop/</div>
<div id='rr'>/restart</div>
<script>
var svg = document.getElementById('svg'); 
var path_elem = document.getElementById('path'); 

document.getElementById('pp').onclick = function(){ cancelAnimationFrame(frame); clearTimeout(timeout_next); }; 
document.getElementById('rr').onclick = function(){ window.location.reload(); }

var d_string = "M596 607.5q95 -92.5 95 -245.5t-98.5 -257.5t-251.5 -104.5h-172l-125 -5q-14 0 -14 13.5t11 13.5l29 2q20 2 33 12.5t13 28.5v569q0 36 -46 40l-29 3q-11 2 -11 13q0 14 14 14l125 -4h172q160 0 255 -92.5zM538 550q-30 48 -81 76t-117 28h-90q-22 0 -35.5 -12 t-13.5 -35v-515q0 -21 13.5 -33.5t35.5 -12.5h95q115 0 184 79t69 205t-60 220z"; 

var a_string = "M227 275h223q11 0 7 12l-119 306l-119 -308q-3 -10 8 -10zM134 66q-2 -6 -2 -13.5t8 -17t22 -10.5l22 -2q13 -2 13 -13q0 -14 -15 -14l-87 4l-91 -4q-14 0 -14 13.5t11 13.5l19 2q43 5 58 41l257 633q4 12 23.5 12t24.5 -12l256 -633q13 -37 57 -41l21 -2q4 0 7 -4t3 -8 q0 -15 -14 -15l-115 4l-103 -4q-14 0 -14 12q0 14 12 15l23 2q13 1 21.5 10t8.5 17t-3 14l-59 153q-3 10 -16 10h-259q-12 0 -16 -10z";

var n_string = "M613 149v485q0 35 -45 40l-29 3q-11 2 -11 14t14 12l97 -3l78 3q15 0 15 -12t-13 -14l-17 -3q-40 -7 -40 -40v-633q0 -12 -11 -12h-13q-25 0-43 24l-421 539q-2 2 -6 2t-4 -10v-478q0 -33 40 -40l17 -3q13 -2 13 -14t-15 -12l-78 3l-97 -3q-14 0 -14 12t11 14l29 3q46 5 46 40v568q0 35 -40 40l-18 2q-12 2 -12 14.5t15 12.5l80 -3q29 -1 44 -19l417 -535q3 -3 7 -3t4 6z"; 

var y_string = "M698 703q14 0 14 -12t-11 -14l-29 -3q-33 -3 -57 -40l-195 -312q-12 -21 -14 -47v-209q0 -18 13 -28.5t32 -12.5l29 -2q12 0 12 -13q0 -6 -4.5-10t-9.5 -4l-113 4l-100 -4q-14 0 -14 12.5t11 14.5l17 2q41 5 41 41v195q0 19 -9 35l-218 338q-24 37 -58 40l-29 3q-11 2 -11 14t14 12l119 -3l106 2q15 0 15 -13t-12 -14l-19 -2q-18 -2 -23.5 -15t2.5 -24l174 -286q4 -7 9 -7t9 5l171 288q8 11 2.5 23.5t-23.5 15.5l-19 2q-14 2 -12 14.5t15 12.5l78 -2z"; 


var cat_string = "M84.93,74.75c-1.551-2.919-3.309-6.228-3.309-11.422c0-8.688,4.819-11.745,5.015-11.865c0.713-0.422,0.948-1.342,0.526-2.055c-0.423-0.714-1.344-0.948-2.056-0.526c-0.265,0.157-6.485,3.961-6.485,14.446	c0,5.942,2.029,9.761,3.659,12.83c1.168,2.198,2.091,3.935,2.091,5.92c0,1.423-0.31,2.451-0.895,2.975	c-0.596,0.533-1.374,0.454-1.388,0.454c-0.072-0.011-0.145-0.016-0.218-0.016h-5.521c0.643-1.005,1.021-2.195,1.021-3.475V14.391	c0-0.673-0.448-1.264-1.098-1.445c-0.648-0.183-1.338,0.093-1.687,0.669L67.26,25.742c-2.249-0.043-8.854-0.094-28.628-0.094	c-4.199,0-6.277,0.003-7.327,0.01l-6.749-12.995c-0.319-0.614-1.02-0.931-1.687-0.766c-0.672,0.164-1.145,0.766-1.145,1.457v68.66	c0,3.57,2.904,6.475,6.475,6.475h22.922h19.775h10.893c0.098,0.009,0.238,0.018,0.412,0.018c0.733,0,2.053-0.163,3.215-1.166	c1.297-1.121,1.955-2.892,1.955-5.265C87.371,79.345,86.186,77.113,84.93,74.75z M37.525,49.302c-2.884,0-5.23-2.346-5.23-5.23	s2.347-5.23,5.23-5.23s5.23,2.346,5.23,5.23S40.409,49.302,37.525,49.302z M52.172,55.328h-1.108l-0.121,2.084	c-0.046,0.797-0.707,1.413-1.496,1.413c-0.029,0-0.059-0.001-0.088-0.002c-0.827-0.048-1.459-0.758-1.41-1.584l0.111-1.91h-1.138	c-0.828,0-1.5-0.671-1.5-1.5s0.672-1.5,1.5-1.5h5.25c0.828,0,1.5,0.671,1.5,1.5S53,55.328,52.172,55.328z M61.568,49.302 c-2.884,0-5.23-2.346-5.23-5.23s2.347-5.23,5.23-5.23c2.885,0,5.232,2.346,5.232,5.23S64.453,49.302,61.568,49.302z";

var dog_string = "M57.792,18.208c-3.25-0.458-4.208-4.167-8.25-4.417c0,0-3.542,0.083-5.583,1.167l-5.333-3.208c0,0-0.5,2.625,2.5,5.625	c0,0-2,9-5,9S19.062,29.5,11.875,24c0,0-6.125-6.188-7.5-5.125c-3.325,2.569,6.125,9.375,8.5,10.75c0,0-3.5,27.5,3,27.5	c0,0,3.25,0.708,3.25-16.375c0,0,8.949,4.9,20.199,4.15c0,0-1.574,12.319,3.426,12.335c5,0.015,3-11.735,2.75-16.11	c0,0,4.125-11.875,4-14.375c0,0,6.75,2.625,7.625,1c0,0,0.958-1.208-2.792-3.208c0,0,5.292-0.333,5.917-3.75	C60.25,20.792,61.042,18.667,57.792,18.208z";

var frog_string = "M28.524,7.374c1.967-1.649-0.856-0.77-0.856-0.77c1.209-2.266-0.703-1.059-0.703-1.059	c-0.203,1.31-0.807,1.512-0.807,1.512c-2.923,2.52-5.439,2.167-5.439,2.167s0.035-0.469,0.06-1.176	c1.717-0.719,2.659-2.602,2.659-2.602c0.907-1.813,1.913-1.663,1.913-1.663c4.283-0.806,0.354-1.159,0.354-1.159	c2.72-3.123-0.807-0.906-0.807-0.906c-0.454-3.475-1.11-0.605-1.11-0.605c0.125,3.413-2.113,5.218-2.981,5.791	c0.004-0.789-0.014-1.683-0.088-2.516c-0.204-2.216-2.216-1.461-3.93-1.059c-1.713,0.404-2.57,1.562-2.017,2.067	c0.557,0.504,0.657,1.208,0.454,3.021c-0.2,1.813-3.526,2.872-5.136,3.325c-1.613,0.453-5.493-0.404-6.046-0.569	C3.49,11.005,3.39,10.632,3.39,10.632c-0.553-1.156-0.906,0-0.906,0l0.199,0.757c-6.096,0.151,0.101,1.008,0.101,1.008	c-3.124,1.763,0.503,0.705,0.503,0.705c0.103-0.705,2.824-0.48,2.824-0.48c4.283,0.175,3.172,4.056,3.172,4.056	c-2.923,4.734-6.853,2.468-6.853,2.468c-2.82-0.352-0.351,1.159-0.351,1.159c-3.879,1.259,0.404,1.11,0.404,1.11	C0.57,23.128,3.287,22.02,3.287,22.02c0.707-0.707,2.017-1.161,2.017-1.161c14.559-4.18,15.665-9.921,15.665-9.921	c3.979-0.707,4.333-1.511,5.089-2.116c0.753-0.604,1.913-0.152,1.913-0.152C30.641,8.92,28.524,7.374,28.524,7.374z M17.745,7.863	c-0.917,0-1.663-0.789-1.663-1.761c0-0.975,0.746-1.765,1.663-1.765c0.917,0,1.664,0.791,1.664,1.765	C19.409,7.074,18.663,7.863,17.745,7.863z"; 

com_strings = commensurate({paths:[d_string, a_string, n_string, y_string], subpath_interleave:"cis", command_interleave:"low"});//, subpath_interleave:"cis", command_interleave:"low"}); 
var extr1_string = com_strings[0];
var extr2_string = com_strings[1]; 
var extr3_string = com_strings[2]; 
var extr4_string = com_strings[3]; 


var test_obj = {test_function: function(){ console.log("callback");}}; 

var subpath_map = []; 
var this_evalstring = ""; 


function initAnim(str){ //consider making this a constructor for an animObj that has relevant values as properties 
	//shouldn't init also determine the intervals
	//and keep them for future reference 
	
	
	//arrayify string 
	var string = str.replace(/[a-zA-Z]/g, " "); 
	string = string.replace(/^ /g, "");
	
	// get subpath map 
	var map = []; 
	var info = new SVGPathInfo(str); 
	var subs = info.getSubPaths(true);
	subs.forEach(function(subpath){
		map.push(subpath.length);
	}); 
	subpath_map = map;  
	
	//get eval string
	this_evalstring = evalString();  //why are we doing this for each? 
	
	return string.split(" "); 
	
}

shape1 = initAnim(extr1_string); 
shape2 = initAnim(extr2_string); 
shape3 = initAnim(extr3_string); 
shape4 = initAnim(extr4_string); 

var allShapes = [shape1, shape2, shape3, shape4, shape2]; 
var index = 0; 

var path = document.getElementById('path');

draw(allShapes[0]);
document.getElementById('ss').onclick = function(){
	animateBeta({start: allShapes[0], end: allShapes[1], segments:100}); 
	document.getElementById('ss').onclick = null;
	document.getElementById('ss').style.color = "#bbb"; 
}; 
var timeout_next; 

function animateNext(){
	queueShapes(); 	
	var startShape = allShapes[0];
	var endShape = allShapes[1];
	timeout_next = setTimeout(function(){
		animateBeta({start: startShape, end: endShape, segments:100}); 
	},100);
};


function queueShapes(){
	allShapes.push(allShapes.shift());
}; 

function animateBeta(object){
	
	var start = object.start;
	var end = object.end;
	var segments = object.segments;
	
	var thisInterval = determineInterval(start, end, segments);
	startAnimationLoop(start, end, thisInterval, segments);
};

function determineInterval(start, end, segments){
	var intervals = [];
	for(i=0; i<start.length;i++){
		intervals[i] = (-(start[i]*1 - end[i]*1)/segments*1);		//the value of the interval could easily be determined by a different function.
	}
	return intervals; 
};

function startAnimationLoop(start,end,interval,segments){
	var currentPosition = start; 
	var so_far = 0; 
	function loopBeta(){
		draw(currentPosition);
		currentPosition = getNextPosition(currentPosition, interval);
		frame = requestAnimationFrame(loopBeta);
		if(so_far > segments) {
			if (typeof test_obj.test_function != "undefined")  test_obj.test_function(); 
			draw(end);
			
			cancelAnimationFrame(frame); 
			animateNext();
		}
		so_far++;
	}
	requestAnimationFrame(loopBeta);
} 

function draw(array, final){
	var a = array; 
	var pathString = eval(this_evalstring);
	
/*	var shadow_path = document.createElementNS("http://www.w3.org/2000/svg", "path");
	shadow_path.setAttribute("d", pathString);
	shadow_path.setAttribute("transform","translate(140,75), scale(1,-1)");
	shadow_path.setAttribute("stroke", "#eee");
	shadow_path.setAttribute("fill", "none");
	svg.insertBefore(shadow_path, path_elem); 
*/	
	path.setAttribute("d", pathString);
	
}

function getNextPosition(currentPosition, interval){
	var position = [];
	for(i=0; i<currentPosition.length; i++){
		position[i] = currentPosition[i]*1 + interval[i]*1; 
	}
	return position;
}

function evalString(){
	var string = ""; 
	var at_value = 0; 
	subpath_map.forEach(function(num){
		var n = 0;
		string += "\"M\" + a[" + (0 + at_value)*1 + "] + \" \" + a[" + (1 + at_value)*1 + "] + "; 
		while (n<(num-1)){
			var start_val = at_value+(n*6)+2; 
			string += " \"C\" + a[" + (at_value+(n*6)+2)*1 + "] + \" \" + a[" + (at_value+(n*6)+3)*1 + "] + \" \" + a[" + (at_value+(n*6)+4)*1 + "] + \" \" + a[" + (at_value+(n*6)+5)*1 + "] + \" \" + a[" + (at_value+(n*6)+6)*1 + "] + \" \" + a[" + (at_value+(n*6)+7)*1 + "] + \" \" +"; 
			n++;
		}
		at_value += 2 + (6*(num-1));
	}); 
	return string.slice(0,string.length-1); 
}




</script>

</body>

</html>
